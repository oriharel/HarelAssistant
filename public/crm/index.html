<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRM - מעקב לידים</title>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="utils.js"></script>
    <script src="app.js"></script>
    <link rel="stylesheet" href="styles.css">
</head>
<body x-data="crmApp()" x-init="init()">
    <!-- Top Bar -->
    <header class="topbar">
        <h1>מעקב לידים - גרין כפר סבא</h1>
        <nav class="tabs">
            <button :class="{ active: tab === 'dashboard' }" @click="showDashboard()">דשבורד</button>
            <button :class="{ active: tab === 'leads' }" @click="showLeads()">לידים</button>
        </nav>
    </header>

    <!-- Error Banner -->
    <div x-show="error" class="error-banner" x-text="error" @click="error = null"></div>

    <!-- Loading -->
    <div x-show="loading" class="loading">טוען...</div>

    <!-- ==================== DASHBOARD TAB ==================== -->
    <main x-show="tab === 'dashboard' && !loading" class="container">
        <!-- Summary Cards -->
        <div class="summary-cards">
            <div class="card stat-card">
                <div class="stat-value" x-text="leads.length"></div>
                <div class="stat-label">סה״כ לידים</div>
            </div>
            <div class="card stat-card">
                <div class="stat-value" x-text="activeCount"></div>
                <div class="stat-label">פעילים</div>
            </div>
            <div class="card stat-card">
                <div class="stat-value" x-text="funnel.find(f => f.stage === 'viewing_scheduled')?.count || 0"></div>
                <div class="stat-label">ביקורים מתוכננים</div>
            </div>
            <div class="card stat-card">
                <div class="stat-value" x-text="funnel.find(f => f.stage === 'negotiating')?.count || 0"></div>
                <div class="stat-label">במו״מ</div>
            </div>
        </div>

        <!-- Funnel -->
        <div class="card">
            <h2>משפך מכירות</h2>
            <div class="funnel">
                <template x-for="item in funnel" :key="item.stage">
                    <div class="funnel-row" x-show="item.stage !== 'closed_won' && item.stage !== 'lost'">
                        <span class="funnel-label" x-text="item.label"></span>
                        <div class="funnel-bar-bg">
                            <div class="funnel-bar"
                                 :style="`width: ${funnelTotal ? (item.count / funnelTotal * 100) : 0}%; background: ${stageColor(item.stage)}`">
                            </div>
                        </div>
                        <span class="funnel-count" x-text="item.count"></span>
                    </div>
                </template>
                <!-- Won/Lost summary -->
                <div class="funnel-footer">
                    <span class="badge badge-won" x-text="'נסגרו: ' + (funnel.find(f => f.stage === 'closed_won')?.count || 0)"></span>
                    <span class="badge badge-lost" x-text="'אבדו: ' + (funnel.find(f => f.stage === 'lost')?.count || 0)"></span>
                </div>
            </div>
        </div>

        <!-- Sources -->
        <div class="card">
            <h2>לפי מקור</h2>
            <div class="sources-chart">
                <template x-for="item in sources" :key="item.source">
                    <div class="source-row" x-show="item.count > 0">
                        <span class="source-dot" :style="`background: ${sourceColor(item.source)}`"></span>
                        <span class="source-label" x-text="item.label"></span>
                        <div class="source-bar-bg">
                            <div class="source-bar"
                                 :style="`width: ${sourcesTotal ? (item.count / sourcesTotal * 100) : 0}%; background: ${sourceColor(item.source)}`">
                            </div>
                        </div>
                        <span class="source-count" x-text="item.count"></span>
                    </div>
                </template>
            </div>
        </div>

        <!-- Recent Activity -->
        <div class="card">
            <h2>פעילות אחרונה</h2>
            <div x-show="recentActivity.length === 0" class="empty">אין לידים עדיין</div>
            <template x-for="lead in recentActivity" :key="lead.id">
                <div class="activity-item" @click="showDetail(lead.id)">
                    <div class="activity-name" x-text="lead.name"></div>
                    <span class="badge" :style="`background: ${stageColor(lead.stage)}; color: white`" x-text="stageLabel(lead.stage)"></span>
                    <span class="activity-time" x-text="timeAgo(lead.updatedAt)"></span>
                </div>
            </template>
        </div>
    </main>

    <!-- ==================== LEADS TAB ==================== -->
    <main x-show="tab === 'leads' && !loading" class="container">
        <!-- Controls -->
        <div class="leads-controls">
            <button class="btn btn-primary" @click="openNewForm()">+ ליד חדש</button>
            <input type="search" class="search-input" placeholder="חיפוש..." x-model="searchQuery">
            <select class="filter-select" x-model="filterStage">
                <option value="">כל השלבים</option>
                <template x-for="s in stagesOrder()" :key="s">
                    <option :value="s" x-text="stageLabel(s)"></option>
                </template>
            </select>
            <select class="filter-select" x-model="filterSource">
                <option value="">כל המקורות</option>
                <option value="yad2">יד2</option>
                <option value="facebook">פייסבוק</option>
                <option value="madlan">מדלן</option>
                <option value="referral">הפניה</option>
                <option value="other">אחר</option>
            </select>
        </div>

        <!-- Lead Cards -->
        <div x-show="filteredLeads.length === 0" class="empty">אין לידים להצגה</div>
        <div class="lead-cards">
            <template x-for="lead in filteredLeads" :key="lead.id">
                <div class="card lead-card" @click="showDetail(lead.id)">
                    <div class="lead-card-header">
                        <strong x-text="lead.name"></strong>
                        <span class="badge" :style="`background: ${stageColor(lead.stage)}; color: white`" x-text="stageLabel(lead.stage)"></span>
                    </div>
                    <div class="lead-card-meta">
                        <span x-text="lead.phone"></span>
                        <span class="source-tag" :style="`border-color: ${sourceColor(lead.source)}`" x-text="sourceLabel(lead.source)"></span>
                    </div>
                    <div class="lead-card-footer">
                        <span x-text="timeAgo(lead.updatedAt)"></span>
                        <span x-show="lead.notes.length" x-text="lead.notes.length + ' הערות'"></span>
                    </div>
                </div>
            </template>
        </div>
    </main>

    <!-- ==================== DETAIL TAB ==================== -->
    <main x-show="tab === 'detail' && currentLead && !loading" class="container">
        <button class="btn btn-back" @click="showLeads(); refresh()">← חזרה</button>

        <div class="card detail-header">
            <div class="detail-top">
                <h2 x-text="currentLead?.name"></h2>
                <div class="detail-actions">
                    <button class="btn btn-sm" @click="openEditForm(currentLead)">עריכה</button>
                    <button class="btn btn-sm btn-danger" @click="confirmDelete(currentLead)">מחיקה</button>
                </div>
            </div>
            <div class="detail-info">
                <div><strong>טלפון:</strong> <a :href="'tel:' + currentLead?.phone" x-text="currentLead?.phone"></a></div>
                <div x-show="currentLead?.email"><strong>אימייל:</strong> <span x-text="currentLead?.email"></span></div>
                <div><strong>מקור:</strong>
                    <span class="source-tag" :style="`border-color: ${sourceColor(currentLead?.source)}`" x-text="sourceLabel(currentLead?.source)"></span>
                </div>
                <div><strong>נוצר:</strong> <span x-text="formatDate(currentLead?.createdAt)"></span></div>
                <div x-show="currentLead?.firstContactAt"><strong>קשר ראשון:</strong> <span x-text="formatDate(currentLead?.firstContactAt)"></span></div>
                <div x-show="currentLead?.viewingAt"><strong>ביקור:</strong> <span x-text="formatDate(currentLead?.viewingAt)"></span></div>
                <div x-show="currentLead?.lostReason"><strong>סיבת אובדן:</strong> <span x-text="currentLead?.lostReason"></span></div>
            </div>
        </div>

        <!-- Stage Stepper -->
        <div class="card">
            <h3>שלב נוכחי</h3>
            <div class="stage-stepper">
                <template x-for="s in stagesOrder()" :key="s">
                    <button class="stage-step"
                            :class="{ current: currentLead?.stage === s, past: stagesOrder().indexOf(s) < stagesOrder().indexOf(currentLead?.stage) }"
                            :style="currentLead?.stage === s ? `background: ${stageColor(s)}; color: white` : ''"
                            @click="changeStage(currentLead.id, s)"
                            x-text="stageLabel(s)">
                    </button>
                </template>
            </div>
        </div>

        <!-- Notes / Timeline -->
        <div class="card">
            <h3>הערות</h3>
            <div class="note-form">
                <textarea x-model="newNote" placeholder="הוסף הערה..." rows="2"></textarea>
                <button class="btn btn-primary" @click="addNote()">הוסף</button>
            </div>
            <div class="timeline">
                <template x-for="note in (currentLead?.notes || []).slice().reverse()" :key="note.id">
                    <div class="timeline-item">
                        <div class="timeline-time" x-text="formatDateTime(note.createdAt)"></div>
                        <div class="timeline-text" x-text="note.text"></div>
                    </div>
                </template>
                <div x-show="!currentLead?.notes?.length" class="empty">אין הערות עדיין</div>
            </div>
        </div>
    </main>

    <!-- ==================== ADD/EDIT MODAL ==================== -->
    <div x-show="showForm" class="modal-overlay" @click.self="closeForm()">
        <div class="modal card">
            <h2 x-text="editingLead ? 'עריכת ליד' : 'ליד חדש'"></h2>
            <form @submit.prevent="submitForm()">
                <label>שם *
                    <input type="text" x-model="form.name" required>
                </label>
                <label>טלפון *
                    <input type="tel" x-model="form.phone" required dir="ltr">
                </label>
                <label>אימייל
                    <input type="email" x-model="form.email" dir="ltr">
                </label>
                <label>מקור
                    <select x-model="form.source">
                        <option value="yad2">יד2</option>
                        <option value="facebook">פייסבוק</option>
                        <option value="madlan">מדלן</option>
                        <option value="referral">הפניה</option>
                        <option value="other">אחר</option>
                    </select>
                </label>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary" x-text="editingLead ? 'עדכן' : 'צור'"></button>
                    <button type="button" class="btn" @click="closeForm()">ביטול</button>
                </div>
            </form>
        </div>
    </div>
</body>
</html>
